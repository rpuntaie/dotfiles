#!/usr/bin/env sh

# https://incenp.org/notes/2015/using-an-offline-gnupg-master-key.html
LABEL=${SECRET_KEY_DEVICE_LABEL:-ARCH_201512}
KEYFILE=$USER/my-secret-key.asc
device=$(findfs LABEL=$LABEL)
if [ -n "$device" ]; then
    udisksctl mount --block-device $device
    tmpdir=$(mktemp -d -p $XDG_RUNTIME_DIR gpg.XXXXXX)
    gpg2 --homedir $tmpdir --import /run/media/$USER/$LABEL/$KEYFILE
    udisksctl unmount --block-device $device
    gpg2 --homedir $tmpdir --keyring ${GNUPGHOME:-$HOME/.gnupg}/pubring.kbx $@
    [ -f $tmpdir/S.gpg-agent ] && gpg-connect-agent --homedir $tmpdir KILLAGENT /bye
    rm -rf $tmpdir
fi
