#!/usr/bin/env sh

if ! systemctl --type service | grep net | grep active > /dev/null; then
    echo no network
fi

# Optional parameter: email address
# Without parameter: all emails
WANT_EMAIL=$1

# $MAILDIR/$email are the according local mail dirs
# $MAILDIR/xyz are created in .dotmuch/post-new according afew/config

# Mutt account setup is generated from these files.
# Emails are retrieved from these files.
# - group or channel name must be = email
# - Path must end in = email
MBSYNCRC=$XDG_CONFIG_HOME/isync/mbsyncrc

# - file = email
# - path must end in = email
GETMAILRCS=$XDG_CONFIG_HOME/getmail/*

function _muttrc()
{
    local email=${1%%/*}
    mkdir -p $MAILDIR/$email
    cat > $MAILDIR/${email}.muttrc <<EOF
#generated by mymailsync
set from = "$email"
set sendmail = "/usr/bin/msmtp -a \$from"
set folder = "$MAILDIR/$email"
set spoolfile = "+INBOX"
set record = "+Sent"
set postponed = "+Drafts"
set trash = "+Trash"
EOF
    echo "source \$MAILDIR/${email}.muttrc
folder-hook \$folder 'source \$MAILDIR/${email}.muttrc'
" >> $MAILDIR/accounts.muttrc
}

function _accounts()
{
    echo "#generated by mymailsync" > $MAILDIR/accounts.muttrc
    if [[ -n $WANT_EMAIL ]]; then
        gmrc=$XDG_CONFIG_HOME/getmail/$WANT_EMAIL
        if [[ -f $gmrc ]]; then
            GMFOLDER=$(cat $gmrc | sed -ne "s/^path\s*=\s*//p")
            for adir in "${GMFOLDER}"{cur,new,tmp}; do
                mkdir -p ${adir/#\~/$HOME}
            done
        fi
        _muttrc $WANT_EMAIL
    else
        LOCALSTORES=""
        if [[ -f $MBSYNCRC ]]; then
            LOCALSTORES+=" $(cat $MBSYNCRC | sed -ne "s/^Path\s*//p")"
        fi
        for gmrc in $GETMAILRCS; do
            GMFOLDER=$(cat $gmrc | sed -ne "s/^path\s*=\s*//p")
            for adir in "${GMFOLDER}"{cur,new,tmp}; do
                mkdir -p ${adir/#\~/$HOME}
            done
            LOCALSTORES+=" $GMFOLDER"
        done
        for store in $LOCALSTORES; do
            local STOREPATH=${store/#\~/$HOME}
            _muttrc ${STOREPATH#$MAILDIR/}
        done
    fi
}

function _sync()
{
    if [[ -n $WANT_EMAIL ]]; then
        gmrc=$XDG_CONFIG_HOME/getmail/$WANT_EMAIL
        if [[ -f $gmrc ]]; then
            /usr/bin/getmail --rcfile=$WANT_EMAIL --getmaildir=$XDG_CONFIG_HOME/getmail
        else
            /usr/bin/mbsync -c $MBSYNCRC $WANT_EMAIL
        fi
    else
        if [[ -f $MBSYNCRC ]]; then
            CHANNEL=$(cat $MBSYNCRC | sed -ne "s/Group\s*//p")
            if [[ -z $CHANNEL ]]; then
                CHANNEL=$(cat $MBSYNCRC | sed -ne "s/Channel\s*//p" | sort -u)
            fi
            for account in $CHANNEL; do
                /usr/bin/mbsync -c $MBSYNCRC $account
            done
        fi
        for gmrc in $GETMAILRCS; do
            /usr/bin/getmail --rcfile=${gmrc##*/} --getmaildir=$XDG_CONFIG_HOME/getmail
        done
    fi
    notmuch new
    #notmuch also created afew MailMover target mailboxes
}

function _mailboxes()
{
    tree -df $MAILDIR | sed -ne "s,^[^/]*/,,p" | sed -ne "s,/cur,,p" | sed -e "s,.*,mailboxes /\0,g"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    _accounts
    _sync
    _mailboxes > $MAILDIR/mailboxes
fi
