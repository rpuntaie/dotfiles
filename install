#!/usr/bin/bash

#https://git.io/fjVcp
#rpuntaie-meta needs about 40GB disk space
#according rpuntaie-meta on https://github.com/rpuntaie/rollarch

if [[ ! -f /usr/bin/stow ]]; then
    echo "you need to do: sudo pacman -S stow" >&2 && exit
fi

if [[ ! -f /usr/bin/xdg-user-dirs-update ]]; then
    echo "you need to do: sudo pacman -S xdg-user-dirs" >&2 && exit
fi


dotfilesurl=https://github.com/rpuntaie/dotfiles
cd ~

if [[ -d dotfiles ]]; then
  cd dotfiles
  if [[ ! "$(git config --get remote.origin.url)"=="$dotfilesurl" ]]; then
    echo "This install script is for a different dotfiles" >&2
    exit 1
  fi
  cd ~
  bash ~/dotfiles/bin/restowdots
else
  #if .dotfiles exits: $new_install=true ~/dotfiles/install
  new_install=true
  git clone $dotfilesurl
  bash ~/dotfiles/bin/restowdots -S
fi

if [[ -n $new_install ]] && $new_install; then
  fc-cache -fv
  bash ~/dotfiles/bin/my_python
  NPM_CONFIG_PREFIX=~/.local/var/lib/npm bash ~/dotfiles/bin/my_nodejs
  rsync -a ~/dotfiles/etc/weechat/ ~/.local/var/lib/weechat/
  mkdir -p ~/.local/var/lib/weechat/ssl
  cd ~/.local/var/lib/weechat/ssl
  openssl req -nodes -newkey rsa:2048 -keyout relay.pem -x509 -days 365 -out relay.pem -subj "/C=AT/ST=AT/L=AT/O=ME/OU=IT/CN=me.org"
fi

echo -e "\033[0;32mLog out and in, to activate the environment.
First time vim and zsh will install plugins."

#rollarch interprets lines starting with "^#PKG: " or "^#REPO: "
#rollarch rpuntaie-meta is served from another Arch on the LAN via AIP2
#PKG: rpuntaie-meta

