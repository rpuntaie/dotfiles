#!/usr/bin/env sh

#Usage: [NOGDB=1] restowdots [-S]

# Note, the variables in .pam_environment cannot be used here

cd ~

echo paths
umask 077
mkdir -p ~/my
mkdir -p ~/my/task
mkdir -p ~/my/finance
mkdir -p ~/.gnupg
mkdir -p ~/.password-store

#at least the vim config for Windows:
#bash dotfiles/bin/restowdots
if [[ ! $(uname) =~ "Linux" ]]; then
    rsync -av ~/dotfiles/etc/vim/ ~/vimfiles/
    exit 0
fi

if [[ -z "$NOGDB" ]]; then
    echo "gnupg (patience: migh take some time)"
    #keep ~/.gnupg separate, just link the config file
    for gpgfile in $(ls ~/dotfiles/etc/gnupg); do
        ln -sf ~/dotfiles/etc/gnupg/$gpgfile ~/.gnupg/$gpgfile
    done
    AUTHKEYGRIP=$(gpg -K --with-keygrip | sed -n -e "/\[A]/{n;n;p;q}" | sed -n -e "s/^\s*Keygrip = //p")
    if [[ -n $AUTHKEYGRIP ]] && [[ ! $(cat ~/.gnupg/sshcontrol) =~ $AUTHKEYGRIP ]] ; then
        echo $AUTHKEYGRIP > ~/.gnupg/sshcontrol
        ssh-add -L >> ~/.ssh/authorized_keys
        #for other machines: ssh-copy-id 192.168.X.Y
        gpg-connect-agent updatestartuptty /bye
    fi
fi

echo stow
umask 022
mkdir -p ~/.local
rm -rf ~/.local/etc/user-dirs*
stow --ignore=home --no-folding ${1:--R} -t .local dotfiles

# dot files for programs not heeding XDG_Base_Directory are symlinked to ``~/dotfiles/home``
# ~/.ledgerrc
# ~/.pam_environment
mv -f ~/.bashrc ~/org.bashrc
cd ~/dotfiles
stow home
cd ~

echo xmonad
rm -rf ~/.xmonad
ln -sf ~/.local/etc/xmonad .xmonad
xmonad --recompile

#see ~/dotfiles/etc/user-dirs.dirs
for adir in $(sed -n -e 's,^X.*/\(.*\)",\1,p' .local/etc/user-dirs.dirs); do
    mkdir -p ~/$adir
done
xdg-user-dirs-update #sets non-existing dirs to homedir
